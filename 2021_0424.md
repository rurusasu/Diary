---
marp: true
theme: template
---

これまでの研究で集めた混同行列は、下図のように行の順番が 0, 10, 100, 105, ... のように並んでいた. Accuracy や Recall を計算する上では、この並びでも問題なかったがデータを整理する際に ±5 度の誤差を許容した結果を求めようと思ったとき、この並びでは不便だったので今日はこの行の順番を操作し、正しくソートするプログラムを組む.

# CSV ファイルを読み込みソート

## csv ファイルを読み込む

csv ファイルを pandas で読み込む方法はとても簡単で、以下のように行う.

```python
$ df = pd.read_csv(file_path, header=None)
```

ここで、`header = None` は 『[pandas で csv/tsv ファイル読み込み(read_csv, read_table)](https://note.nkmk.me/python-pandas-read-csv-tsv/)』より

> header=None とすると連番が列名 columns に割り当てられる。

また、`read_csv` の引数については『[Pandasのread_csv関数でCSVファイルを読み込む方法](https://deepage.net/features/pandas-readcsv-light.html)』も参考になる.

---

これまでの操作によって、混同行列は以下のような形でとりこめた.

![confution_1](https://raw.githubusercontent.com/rurusasu/Diary/master/%E7%94%BB%E5%83%8F/2021_0430/Confution_1.png)

ラベルは 0$^\circ$ から 175$^\circ$ まで順番に並んでほしいが、生データのままでは、順番が違う形でソートされている.

---

## 1行1列目の値をもとに行列の順番をソート

そこで、1列目の値を基に行の順番をソートする．

`pandas DataFrame` のソートは、『[Pandasで列データをソートするsort_values関数の使い方](https://deepage.net/features/pandas-sort-values.html)』を参考に，以下のように引数に値を渡した．

```python
$ df_row_sort = f_csv.sort_values(0, axis=0, ascending=True, na_position='first')
```

ここで、まず第1引数の `by` は 1列目(1行目)の列データを使ってソートすることを表し、第2引数 `axis` は、ソートする方向を  `0` または `index` で行方向，`1` または `columns` で列方向と指定できる．第3引数の `ascending` は `True`  で昇順にならべる、`False` で降順に並べるかを指定できる．第4引数の `na_position` は `first` でNaN値を先頭に起き、`last` で最後尾に置くことを指定できる．

これで行方向のソートができた．次に、同様のコードで列方向をソートする．

```python
$ df_col_sort = df_row_sort.sort_values(0, axis=1, ascending=True, na_position='first')
```
こちらは，先程のコードの第2引数を `1` として列方向にソートを行うようにしたものです．

---

この結果、混同行列は以下のようにソートされた．

![Confution_2](https://raw.githubusercontent.com/rurusasu/Diary/master/%E7%94%BB%E5%83%8F/2021_0430/Confution_2.png)

---

## 行列を転置する

以上でソートは完了したが，個人的に欲しい行列はこの行列を転置したものであるため，『[pandas.DataFrameの行と列を入れ替える(転置)](https://note.nkmk.me/python-pandas-t-transpose/)』を参考に混同行列を転置する．

転置の方法は簡単で，以下のように転置したい `DataFrame` の後ろに `.T` をつけるだけ．
```python
$ df_col_sort.T
```

## 変更したデータを保存

ここで一度変更したデータを `csv` ファイルとして保存する．『[pandasでcsv/tsvファイル読み込み(read_csv, read_table)](https://note.nkmk.me/python-pandas-read-csv-tsv/)』を参考に `csv` ファイルに書き込む．

```python
$ df_col_sort.to_csv(save_sort_path, header=None, index=False)
```

ここで，第1引数は拡張子を含めた保存先の Path を指定する．第2引数は `header` (Excel の A, B, C のように付けられる列名の pandas 版) を付けたまま保存するかを指定する． `False` の場合は付けずに保存，`True` の場合は付けずに保存する．第3引数は `index` (Excel でいう行番号の pandas 版)を付けたまま保存するかを指定する．`False` の場合は付けずに保存，`True` の場合は付けたまま保存する．

---

## matplotlib で混同行列を3dグラフ化

混同行列を見やすくするために，行をX軸，列をY軸，要素をZ軸として3ｄプロットする．そこで『[pandas+matplotlibで3D棒グラフを作る](https://hpcmemo.hatenablog.com/entry/2015/10/08/200647)』を参考に以下のようなプログラムを作成した．


```python
import numpy as np
from matplotlib import pyplot as plt
from mpl_toolkits.mplot3d import Axes3D

# 3D グラフの初期化
fig = plt.figure()
ax = fig.gca(projection='3d')
# データの準備
Xgrid = df.columns.values.astype(np.int16)
Ygrid = df.index.values.astype(np.int16)
# グリッド作成
X, Y = np.meshgrid(Xgrid, Ygrid)
X = X.flatten()
Y = Y.flatten()
Z = np.zeros(len(X))
dx = np.full(len(X), 5)
dy = np.full(len(Y), 5)
dz = df.values.flatten()
# プロット
ax.bar3d(X, Y, Z, dx, dy, dz)
# ラベル追加
ax.set_xlabel(u"Predict Class")
ax.set_ylabel(u"True Class")
# 表示
plt.show()

```

---

  <DobotType>
    <item_0>Magician</item_0>
  </DobotType>
  <row_StudioVersion>
    <item_0>Ver-194</item_0>
  </row_StudioVersion>
  <row0>
    <item_0>1</item_0> # モーションスタイル
    <item_1 /> # 名前
    <item_2>183.7511</item_2> # x座標
    <item_3>-82.7625</item_3>  # y座標
    <item_4>-3.1059</item_4>    # z座標
    <item_5>-27.621</item_5>    # r座標
    <item_10>0.0</item_10>       # Pause Time
    <item_11>0</item_11>          # Gripper
  </row0>
