---
marp: true
theme: template
---

# Blender をコンパイルする

## 目的

これまで開発環境としてきた ノート PC から デスクトップ PC に環境を変更するにあたって `import bpy` を実行しようとするとエラーが発生し、`pip install bpy` でも目的のパッケージを見つけられなかったため検索をかけたところ、以下のことがわかった。

参考: [【超入門編】Blender Python（BPY）の使い方](http://kutodatabase.com/kuto1970.shop/Works_BPYNyumon.html)

> bpy: Blender の様々な機能を Python で簡単に呼び出せるようにするため，Blender 開発者が公開している橋渡し的な役割を持つモジュール（関数・構造体の集まり）のことです．この橋渡し的な役割を持つモジュールは一般に API と呼ばれています．
> Blender 内の python を用いて操作をする場合、必ず冒頭に"import bpy"と記述する必要があります． これを最初に記述しておくことで bpy と名のついた関数を実行できるようになります．

そして、Blender をビルドすることで、インストール済みの python に組み込むことができるらしい [参考: [Blender のビルド手順 その９（Python モジュールへの Blender2.8 の組み込み）](https://bluebirdofoz.hatenablog.com/entry/2019/10/02/094415)]。

よって、まず Blender をビルドしていく。

---

## ビルド環境を整える

まず、ビルドするための環境を整える。その際、[[Blender] ソースコードから Blender 本体をビルドする](https://qiita.com/nutti/items/2a7d31e224b28142b3d6) を参考にした。

### Visual Studio Community 2019 のインストール

> Blender のコアの部分は C 言語と C++混在で書かれているため、Blender をビルドするためには、Windows 上でビルドするための環境が必要です。

そのために、Microsoft が提供している IDE である [Visual Studio 2019](https://visualstudio.microsoft.com/vs/express/) をインストールする。

インストール中に、追加でダウンロードするパッケージを選択できるが、今回は **C++によるデスクトップ開発** のみを選択した。

<div align="center">
<img src="https://raw.githubusercontent.com/rurusasu/Diary/master/%E7%94%BB%E5%83%8F/2021_0719/vs_studio_install.png" width=800>
</div>

---

### SVN のインストール

> Blender のビルドには、コンパイル済みのライブラリが必要になります。Git はバイナリのバージョン管理には不向きであるため、コンパイル済みのライブラリは SVN で管理されています。

ということで、Blender のコンパイル済みライブラリをダウンロードするために、SVN をインストールする。

最新の SlickSVN は以下の URL から インストールできる。

https://sliksvn.com/download/

svn をインストール後は、exe ファイルにパスを通す必要がある。

例: ｘ 64 をインストールした場合:

```
$ C:\Program Files\SlikSvn\bin\svn.exe
```

をパスに追加し、コマンドプロンプトにて以下のような結果になることを確認する。

```cmd
$ svn
# Type 'svn help' for usage.
```

---

### ソースコード・バイナリの取得

```cmd
$ mkdir blender_dev
$ cd blender_dev
$ git clone https://github.com/blender/blender.git
$ cd blender
$ git submodule update --init --recursive
$ git submodule foreach git checkout master
$ git submodule foreach git pull --rebase origin master
$ cd ..
$ svn checkout https://svn.blender.org/svnroot/bf-blender/trunk/lib/win64_vc12 lib/win64_vc12
```

### プロジェクトファイルの作成

ビルド後の Blender のバイナリを置くためのディレクトリを作成する。

```cmd
$ cd blender_dev
$ mkdir build
```

---

CMake を起動する。**ソースが置かれたディレクトリ** と **ビルドによって作られるデータを置くディレクトリ** を指定し、**configure** をクリックする。

<div align="center">
<img src="https://raw.githubusercontent.com/rurusasu/Diary/master/%E7%94%BB%E5%83%8F/2021_0719/cmake.png" width=600>
</div>

---

続いて表示されるウィンドウでは、インストールした **Visual Studio** を指定して **Finish** をクリック。

<div align="center">
<img src="https://raw.githubusercontent.com/rurusasu/Diary/master/%E7%94%BB%E5%83%8F/2021_0719/cmake2.png" width=600>
</div>

---

### エラー発生

cmake を実行すると、次のようなエラーが発生した。

```cmd
Windows requires pre-compiled libs at:
  'D:/DATA/R2_Miki/blender_dev/blender/../lib/win64_vc15'.  Please run `make
  update` in the blender source folder to obtain them.
Call Stack (most recent call first):
  CMakeLists.txt:936 (include)
```

このエラーについては、以下のサイトに解決方法が記載されていた。

### make をインストールする

まず、次のサイトにしたがって、**make** をインストールする。

[Windows 環境で make コマンドを利用する](https://bluebirdofoz.hatenablog.com/entry/2019/10/24/221517)

1. [make の公式サイト](http://gnuwin32.sourceforge.net/packages/make.htm) にアクセスし、**Complete package, except sources Setup** をクリックする。

<div align="center">
<img src="https://raw.githubusercontent.com/rurusasu/Diary/master/%E7%94%BB%E5%83%8F/2021_0719/make_install_1.png" width=500>
</div>

---

2. ダウンロードした **make.exe** を立ち上げ、**Next**

<div align="center">
<img src="https://raw.githubusercontent.com/rurusasu/Diary/master/%E7%94%BB%E5%83%8F/2021_0719/make_install_2.png" width=300>
</div>

3. **I accept the agreement** -> **Next**
<div align="center">
<img src="https://raw.githubusercontent.com/rurusasu/Diary/master/%E7%94%BB%E5%83%8F/2021_0719/make_install_3.png" width=300>
</div>

---

4. インストール先を指定

<div align="center">
<img src="https://raw.githubusercontent.com/rurusasu/Diary/master/%E7%94%BB%E5%83%8F/2021_0719/make_install_4.png" width=300>
</div>

5. インストールするコンポーネントを選択

<div align="center">
<img src="https://raw.githubusercontent.com/rurusasu/Diary/master/%E7%94%BB%E5%83%8F/2021_0719/make_install_5.png" width=300>
</div>

---

6. スタートメニューの設定を行う。スタートメニューを作りたくない場合は、**Don't create a Start Menu folder** にチェックを入れる。今回は、スタートメニューを作る方を選択した。

<div align="center">
<img src="https://raw.githubusercontent.com/rurusasu/Diary/master/%E7%94%BB%E5%83%8F/2021_0719/make_install_6.png" width=300>
</div>

7. その他のオプション設定を行う。**Create document shortcuts** 特に指定が無ければ、そのまま **Next** をクリックする。

<div align="center">
<img src="https://raw.githubusercontent.com/rurusasu/Diary/master/%E7%94%BB%E5%83%8F/2021_0719/make_install_7.png" width=300>
</div>

---

8. インストールしたディレクトリを環境変数に指定する

```
$ C:\Program Files (x86)\GnuWin32\bin
```

### make update

先ほどのエラーは、`make update` ができていないために発生しているようだった。そこで、以下のコマンドで blender を make update する

```cmd
$ cd blender_dev
$ cd blender
$ make update
```

---

# python 仮想環境構築 (venv を用いる場合)

PVN3D を用いようと git からダウンロードしたディレクトリで `pip install pip3 install -r requirements.txt ` を実行したところエラーが発生したので、仮想環境を構築し改めてインストールを試みる。

## 環境構築

> Python3.3 以上では、パッケージ環境（仮想環境）の切り替えとして venv が標準で使えます。

そこで、まず現在インストールされている python のバージョンを確認する。
参考: [Python:venv + pyenv での環境構築](https://messefor.hatenablog.com/entry/2020/08/22/181519)

```cmd
$ python -V

Python 3.8.5
```

次に、以下のコマンドでカレントディレクトリに仮想環境を構築する。

```cmd
$ python -m venv .venv
```

そして、以下のコマンドで仮想環境を立ち上げる。
参考: [Windows で venv で仮想環境を作成して立ち上げるまでやる](https://zenn.dev/ryotoitoi/articles/0fd021ad9405bf)

```cmd
$ .\.venv\Scripts\activate
```

---

### pip をアップデートする

pip を用いてパッケージをインストールする前に、以下のコマンドで pip をアップデートしておく。

```cmd
$ py -m pip install --upgrade pip
```

### パッケージインストール

以下のコマンドで必要なパッケージを一括でインストールすることができる。

```cmd
$ pip3 install -r requirements.txt
```

### インストールエラー

上記のコマンドでパッケージのインストールを実行したところ、以下のようなエラーが発生した。

```
ERROR: Could not find a version that satisfies the requirement yaml
(from versions: none) ERROR: No matching distribution found for yaml
```

このエラーは、`yaml` パッケージが `pyyaml` と名称変更されていたため、パッケージを見つけられなかったことが原因であった。

参考: [Python 用の yaml パッケージをインストールするにはどうすればよいですか？ ](https://stackoverflow.com/questions/14261614/how-do-i-install-the-yaml-package-for-python)

---

## python-pcl インストール

必要なパッケージをすべてインストールしたら、次に python-pcl をダウンロードしていく。

> ポイントクラウドライブラリ（またはPCL）は、2D / 3D用の大規模なオープンプロジェクトです。

参考: [ PointCloudLibrary](https://pointclouds.org/)

1. [python-pcl](https://github.com/strawlab/python-pcl) の windows インストールから、以下のファイルをダウンロードする。

<div align="center">
<img src="https://raw.githubusercontent.com/rurusasu/Diary/master/%E7%94%BB%E5%83%8F/2021_0719/make_install_7.png" width=300>
</div>

1.