---
marp: true
theme: template
---

# UNet 用データセットの整理

今回実験的に作成する UNet に学習させるためのデータセットを用意する．

[2018 Data Science Bowl](https://www.kaggle.com/c/data-science-bowl-2018/data)

すべてのデータをダウンロードすると、以下のようなフォルダ構造を持つ．

1. stage1_sample_submission.csv.zip
1. stage1_solution.csv
1. stage1_test
1. stage1_train
1. stage1_train_labels.csv
1. stage2_sample_submission_final.csv
1. stage2_test_final

---

そのうち，`stage1_train` を解凍してみると、

```
<stage1_train>
|-- 00ae65
|       |-- images
|       |       |-- 00ae65.png
|       |-- masks
|               |-- 0f33d2a.png
|               |-- 0fe691c.png
|               |-- ...
|
|-- 0a7d30
|       |-- images
|       |       |-- 0a7d30.png
|       |-- masks
|               |-- 0adbf56.png
|               |-- 1ed5b9a.png
|               |-- ...
|
|-- 0acd2c
|       |-- images
|       |       |-- 0acd2c.png
|       |-- masks
|               |-- 2f5eb1.png
|               |-- 3fa2a8.png
|               |-- ...
|...
```

のようになっている．

---

ここから，ディレクトリおよびファイル名を次のように変更する．

このとき，`masks` ディレクトリ内に存在した画像名がすべて `images` ディレクトリ内の画像名と同一になっていることに注意．

```
<stage1_train>
|-- images
|       |-- 00ae65.png
|       |-- 0a7d30.png
|       |-- 0acd2c.png
|-- masks
        |-- 0
        |    |-- 00ae65.png
        |    |-- 0a7d30.png
        |    |-- 0acd2c.png
        |    |-- ...
        |
        |-- 1
        |    |-- 00ae65.png
        |    |-- 0a7d30.png
        |    |-- 0acd2c.png
        |    |-- ...
        |
        |-- 2
        |    |-- 00ae65.png
        |    |-- 0a7d30.png
        |    |-- 0acd2c.png
        |    |-- ...
        |-- ...

```

---

## zipファイルを自動的に展開する

ダウンロードしてきたデータはすべて `zip` 形式で保存されいる．これは，オリジナルデータとして保存しておく分には問題ないが，画像を確認する場合にはいちいち展開しなくてはいけないので，手間がかかる．そこで，`zip` ファイルを自動的に解凍する関数を作成する．

[Python, zip関数の使い方: 複数のリストの要素をまとめて取得](https://note.nkmk.me/python-zip-usage-for/) を参考に，`zipfile` ライブラリを用いて以下のような関数を作成した．

```python
def unpack(self, file_name: str, create_dir: bool=True):
    """originalディレクトリ内のzipファイルを展開するための関数
    Arg:
        file_name(str): original ディレクトリ内の zip ファイル名,
        create_dir(bool optional): 解凍するときに、解凍前のファイル名と同じ名前のディレクトリを作成する。default to True.
    """
    zip_path = os.path.join(self.org_path, file_name + '.zip')
    unpack_path = self.parent_path

    if create_dir:
        try:
            unpack_path = os.path.join(self.parent_path, file_name)
            os.mkdir(unpack_path) # create directry
        except FileExistsError as e:
            print("ディレクトリ作成時にエラーが発生しました: ", e)
            return

    with zipfile.ZipFile(zip_path) as existing_zip:
        existing_zip.extractall(unpack_path)
```

この関数を用いることで，展開前の `zip` ファイルの名前を持つディレクトリ内にファイルを自動的に解凍することができる．

---

## images ディレクトリ内の png 画像を別のディレクトリに移動する．

次に，解凍したディレクトリから新しい訓練データセットを作成するために、ファイルを整理していく．そこで，まず解凍したデータ内のそれぞれのラベル名が付いたディレクトリ内にある `images` ディレクトリ内の画像から移動していく．


## rename する

https://www.sejuku.net/blog/63732

## 拡張子を取得
https://note.nkmk.me/python-os-basename-dirname-split-splitext/

## ディレクトリ名一覧を取得
https://note.nkmk.me/python-glob-usage/

## フォルダの存在確認
https://note.nkmk.me/python-glob-usage/

## フォルダ名に現在時刻を入れる
https://life-freedom888.com/python-file-hiduke/

## Jupyter 上に画像を表示
https://qiita.com/zaburo/items/5637b424c655b136527a
https://ymgsapo.com/2019/07/21/jupyternotebook-image-show/

---


# 画像データ拡張ライブラリ albumentation

## Data Augmentation

## albumentation のインストール

albumentation は `conda install` では見つからないため `conda-forge` から以下の 3 つのコマンドを使用してインストールする．

```
$ >anaconda search albumentations
$ >anaconda show conda-forge/albumentations
$ >conda install --channel https://conda.anaconda.org/conda-forge albumentations
```
