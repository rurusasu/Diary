---
marp: true
theme: template
---

参考 [姿勢の表現：オイラー角、単位クォータニオン、および回転ベクトル（2006](http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.110.5134)

# 物体の回転

## 1.1. オイラー角

欠点

1. 特異点がある．
1. 姿勢の時間的変化を積分する際に単位四元数よりも精度が低いこと

## 1.2. 四元数

欠点

1. 四元数が直感的な物理的意味を持たないこと
1. 四元数が純粋な回転であるためにはユニティノルムを持たなければならないこと

---

## 1.3. 座標系

![bg right 70%](https://raw.githubusercontent.com/rurusasu/Diary/master/%E7%94%BB%E5%83%8F/2021_0517/fig1.png)

2 つの異なる座標系で表現されたデータの関係を考えます。

- ワールド座標系は、慣性空間に固定されています。
- この座標系の原点を $W$ とする。体固定座標系は、姿勢を表現したい物体に固く固定されており，この座標系の原点を $A$ とする。
- 世界座標系においてその原点 $W$ から体内固定座標系の原点 $A$ の位置ベクトルを $^W\bm{q}_A$ とする．反対に，体内固定座標系の原点 $A$ から世界座標系の原点 $W$ の位置ベクトルを $^A\bm{q}_W$ とする．

---

![bg right 50%](https://raw.githubusercontent.com/rurusasu/Diary/master/%E7%94%BB%E5%83%8F/2021_0517/fig2.png)

世界座標系上のある点 $p$ が世界座標系上の位置 $^W\bm{p}$ に存在するとき，体内固定座標系上では $^A\bm{p}$ で与えられるとする．このとき， $^W\bm{p}$ は世界座標系において以下のように表される．

$$
^W\bm{p} = ^A\bm{p} + ^W\bm{q}_A
$$

一方，A 座標系では以下のように表される．

$$
^A\bm{p} = ^A\bm{q}_W + ^W\bm{p}
$$

---

# 2. 回転行列

## 2.1. 2D 平面における回転

![bg right 70%](https://raw.githubusercontent.com/rurusasu/Diary/master/%E7%94%BB%E5%83%8F/2021_0517/fig3.png)

簡単のために，$^W\bm{q}_A = ^A\bm{q}_W = \bm{0}$ かつ，体内固定座標系が世界座標系に対して $\theta$ だけ回転しているとする．

このとき，体内固定座標系のそれぞれの軸の法線ベクトル $\bm{u}, \bm{v}$ は世界座標系のそれぞれの軸の法線ベクトル $\bm{x}, \bm{y}$ を用いて以下のように与えられる．

$$
\bm{u} = \bm{x} \cos(\theta) + \bm{y} \sin(\theta)
$$

$$
\bm{v} = - \bm{x} \sin(\theta) + \bm{y} \cos(\theta)
$$

2 つの座標系において点 $p$ の位置ベクトル $\bm{p}$は

$$
\bm{p} = p_x \bm{x} + p_y \bm{y} = p_u \bm{u} + p_v \bm{v}
$$

とそれぞれの座標軸のベクトル成分に分解できる．

---

この式に，先ほどの 2 つの式を代入して

$$
p_x \bm{x} + p_y \bm{y} = p_u ( \bm{x} \cos(\theta) + \bm{y} \sin(\theta)) + p_v(-\bm{x} \sin(\theta) + \bm{y} \cos(\theta)) \\
= (p_u \cos(\theta) - p_v \sin(\theta)) \bm{x} + (p_u \sin(\theta) + p_v \cos(\theta))\bm{y}
$$

となり，$\bm{x}, \bm{y} \in \mathbb{R}$ では

$$
p_x = p_u \cos(\theta) - p_v \sin(\theta)
$$

$$
p_y = p_u \sin(\theta) + p_v \cos(\theta)
$$

が成り立つ．これをまとめると，

$$
\left[
  \begin{array}{c}
    p_x \\
    p_y
  \end{array}
\right]
=
\left[
  \begin{array}{cc}
    \cos(\theta) & -\sin(\theta) \\
    \sin(\theta) & \cos(\theta)
  \end{array}
\right]
\left[
  \begin{array}{c}
    p_u \\
    p_v
  \end{array}
\right]
$$

となり，

$$
^W\bm{p} = \; ^W\bm{R}_A \; ^{A}\bm{p}
$$

$$
^W\bm{R}_A =
\left[
  \begin{array}{cc}
    \cos(\theta) & -\sin(\theta) \\
    \sin(\theta) & \cos(\theta)
  \end{array}
\right]
$$

---

一方，世界座標系から見た $\^Abm{p}$ は以下のように与えられる．

$$
^A\bm{p} = \; ^A\bm{R}_W \; ^W\bm{p}
$$

$$
^A\bm{R}_W =
\left[
  \begin{array}{cc}
    \cos(-\theta) & -\sin(-\theta) \\
    \sin(-\theta) & \cos(-\theta)
  \end{array}
\right]
=
\left[
  \begin{array}{cc}
    \cos(\theta) & \sin(\theta) \\
    -\sin(\theta) & \cos(\theta)
  \end{array}
\right]
$$

さらに，

$$
^W \bm{R}_A \; ^A\bm{R}_W =
\left[
  \begin{array}{cc}
    \cos(\theta) & -\sin(\theta) \\
    \sin(\theta) & \cos(\theta)
  \end{array}
\right]
\left[
  \begin{array}{cc}
    \cos(\theta) & \sin(\theta) \\
    -\sin(\theta) & \cos(\theta)
  \end{array}
\right]
$$

$$
=
\left[
  \begin{array}{cc}
    \cos^2(\theta)+\sin^2(\theta) & \cos(\theta)\sin(\theta)-sin(\theta)cos(\theta) \\
    \sin(\theta)\cos(\theta)-\cos(\theta)\sin(\theta) & \sin^2(\theta)\ + cos^2(\theta)
  \end{array}
\right]
$$

$$
= \left[
  \begin{array}{cc}
    1 & 0 \\
    0 & 1
  \end{array}
\right]
=
\bm{I}
$$

すなわち

$$
^W\bm{R}_A = (^A\bm{R}_W)^{-1}
$$

が成り立つ．つまり，回転行列の逆行列が逆回転を表すことになる．

## 2.2. 2D 平面における並進移動と回転

以上のことから，2 つの座標系間の座標変換は次式で与えられる．

$$
^W\bm{p} = ^W\bm{q}_A + ^W\bm{R}_A \; ^A\bm{p}
$$

---

# 3. 同次変換行列

2D 平面における 2 つの座標系の座標変換の式を再度成分ごとで書き表すと，

$$
\left[
  \begin{array}{c}
    p_x \\
    p_y
  \end{array}
\right]
=
\left[
  \begin{array}{c}
    q_x \\
    q_y
  \end{array}
\right]
+
\left[
  \begin{array}{cc}
    \cos(\theta) & -\sin(\theta) \\
    \sin(\theta) & \cos(\theta)
  \end{array}
\right]
\left[
  \begin{array}{c}
    p_u \\
    p_v
  \end{array}
\right]
$$

この右辺の計算を 1 つにまとめると

$$
\left[
  \begin{array}{c}
    p_x \\
    p_y
  \end{array}
\right]
=
\left[
  \begin{array}{ccc}
    \cos(\theta) & -\sin(\theta) & q_x \\
    \sin(\theta) & \cos(\theta) & q_y
  \end{array}
\right]
\left[
  \begin{array}{c}
    p_u \\
    p_v \\
    1
  \end{array}
\right]
$$

と書き換えることができる．さらにこの式に

$$
1 = \left[
  \begin{array}{ccc}
    0, & 0, & 1
  \end{array}
\right]
\left[
  \begin{array}{c}
    p_u \\
    p_v \\
    1
  \end{array}
\right]
$$

を加えて

$$
\left[
  \begin{array}{c}
    p_x \\
    p_y \\
    1
  \end{array}
\right]
=
\left[
  \begin{array}{ccc}
    \cos(\theta) & -\sin(\theta) & q_x \\
    \sin(\theta) & \cos(\theta) & q_y \\
    0 & 0 & 1
  \end{array}
\right]
\left[
  \begin{array}{c}
    p_u \\
    p_v \\
    1
  \end{array}
\right]
$$

と表記する．

---

よって，

$$
\left[
  \frac{^A\bm{p}}{1}
\right]
=
\left[
  \begin{array}{lcr}
    \frac{^W\bm{R}_A}{\bm{0}} & | &
    \frac{^W\bm{q}_A}{\bm{1}}
  \end{array}
\right]
\left[
  \frac{^W\bm{p}}{1}
\right]
$$

となり，これによって並進移動 + 回転という座標変換が

$$
^W\bm{p} =
^W\bm{T}_A \; ^A\bm{p}
$$

という形で表現できるようになった．

## 3.2. 連続変換

これまでの座標系に1つ増やして，$W, A, B$ の3つを考える．ここで，$W$ と $A$，$A$ と $B$ の関係がわかっている場合，すなわち

$$
^W\bm{p} = ^W\bm{T}_A \; ^A\bm{p}
$$
$$
^A\bm{p} = ^A\bm{T}_B \; ^B\bm{p}
$$

の場合，$W$ と $B$ の関係は単純に $^A\bm{p}$ を代入して

$$
^W\bm{p} = ^W\bm{T}_B \; ^B\bm{p}
$$
$$
 = ^W\bm{T}_A \; ^A\bm{T}_B \; ^B\bm{p}
$$
と表される．すなわち，連続変換は同時変換行列を重ねることによって表現できる．

---

# 4. 3D空間における並進移動と回転

これまで扱ってきた2Dでの回転は，原点を中心とした回転であった．これをそのまま3Dに拡大すると，「原点を通る軸を中心とした回転」となる．そこでまず，特に扱いの容易な座標軸を中心とした回転を考える．2D平面における回転の式

$$
\left[
  \begin{array}{c}
    p_x \\
    p_y
  \end{array}
\right]
=
\left[
  \begin{array}{cc}
    \cos(\theta) & -\sin(\theta) \\
    \sin(\theta) & \cos(\theta)
  \end{array}
\right]
\left[
  \begin{array}{c}
    p_u \\
    p_v
  \end{array}
\right]
$$

に対して，新たに座標系 $W$ に $Z$ 軸，座標系 $A$ に $S$ 軸を加える．ここで左手座標系の定義に従って $\bm{x} \times \bm{y} = -\bm{z}$ となるように $Z$ 軸をとり，その $Z$ 軸まわりの回転を考える．すると，回転の式は拡張されて，

$$
\left[
  \begin{array}{c}
    p_x \\
    p_y \\
    p_z
  \end{array}
\right]
=
\left[
  \begin{array}{ccc}
    \cos(\theta) & -\sin(\theta) & 0 \\
    \sin(\theta) & \cos(\theta) & 0 \\
    0 & 0 & -1
  \end{array}
\right]
\left[
  \begin{array}{c}
    p_u \\
    p_v \\
    p_s
  \end{array}
\right]
$$

---

## 4.1. 並進移動


## 4.2. 回転



回転行列 $R$ とは，

> ベクトルとの掛け算で，その長さを保ったままベクトルを回転させる行列のこと．

すべての 3x3 回転行列の特別な直交群を $SO(3)$ と呼び，$R \in SO(3)$ の場合は

$$
\det{R} = \pm 1
$$

$$
R^{-1} = R^T
$$

---

## 2.1. 座標変換

剛体の姿勢を符号化する回転行列 $R$ を

> 世界座標で表されたベクトルに前置乗算すると、体内固定座標で表された同じベクトルが得られる行列

と定義する。すなわち，$\bm{z} \in \mathbb{R}^3$ を世界座標で表されたベクトルとし，$\bm{z}′ \in \mathbb{R}^3$ を身体固定座標で表された同じベクトルとすると，次のような関係が成り立つ。

$$
\bm{z}' = R \bm{z}
$$

$$
\bm{z} = R^T \bm{z}'
$$

---

![bg right 70%](https://raw.githubusercontent.com/rurusasu/Diary/master/%E7%94%BB%E5%83%8F/2021_0517/fig4.png)

位置ベクトル $\bm{x}_b$ に定義されていた体内座標系に回転行列 $R$ をかけることにより移動されたとする．このとき，この座標系の原点は，世界座標系上において $r\bm{x}_b$ で表され，反対に移動した体内座標系の原点から世界座標系の原点の位置は $R \bm{x}_w'$ で表される．

---

![bg right 70%](https://raw.githubusercontent.com/rurusasu/Diary/master/%E7%94%BB%E5%83%8F/2021_0517/fig5.png)

移動した体内座標系における点 $p'$ の位置 $\bm{x}'$ は，

$$
\bm{x}' = R\bm{x} - R\bm{x}_b = R(\bm{x} - \bm{x}_b)
$$

一方，体内座標系から世界座標系原点への位置ベクトルを $R \bm{x}_w'$ とすると，

$$
\bm{x} = \frac{1}{R} (\bm{x}' - R \bm{x}_w')
$$
